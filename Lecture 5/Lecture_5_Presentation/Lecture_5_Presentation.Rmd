---
title: "Fundamentals of R"
subtitle: "Lecture 5: Exchanging with the community"
author: "<large>Henrique Sposito and Livio Silva-Muller</large>"
date: "<small>October 21, 2022<small>"
output:
  xaringan::moon_reader:
    css: 
      - "default"
      - "assets/iheid-xaringan-style.css"
      - "https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
      - "ninjutsu"
    chakra: "https://remarkjs.com/downloads/remark-latest.min.js"
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      beforeInit: "assets/macros.js"
      countIncrementalSlides: false
      slideNumberFormat: |
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: calc(%current% / %total% * 100%);">
          </div>
        </div>`
---

```{r setup, include=FALSE}
# don't mind this code chunk, it just sets up a few things for the rest
# it doesn't appear, because the include argument above is FALSE...
options(htmltools.dir.version = FALSE, servr.daemon = TRUE)
knitr::opts_chunk$set(cache=TRUE, autodep = TRUE, fig.retina = 3, message = FALSE, warning = FALSE)
```

class: split two

# What did we learn last week?

--

.pull-left[

Conceptually:

- Gestalt principles

- Tufte's law

- One plot, one story

]

--

.pull-right[

Practically:

```{r, eval=FALSE}
ggplot(data, mapping = aes()) # Do you remember mapping vs setting aesthetics?
# geom_*() # What does the geom functions do?
geom_line() # layering lines
geom_points() # layering points
geom_col() # layering columns
geom_boxplot() # layering box plots
geom_smooth() # layering line over patterns
labs() # modifies plot labels
theme() # customize plot components
# theme_*() # family of preset themes
```

]

**What about scales and normalization?**

---

class: split two

![:scale 30%](assets/images/roadmap.png)

.pull-left[

## Lecture:

  - R Markdown
  
  - Minimal reproducible examples
  
  - The ethics of data
 
]

.pull-right[

## Case Study:

*How the Brazilian Amazon has been constructed as a problem in transnational presidential discourses?*

]

**We will also discuss the final assignment!**

---

# R Markdown, a one-stop shop (Rmd 1/5)

- Write your text, execute code, and produce high quality (reproducible) reports in [one place](https://rmarkdown.rstudio.com/gallery.html)!

- [Made for R, free, and with lots of support](https://bookdown.org/yihui/rmarkdown/)

- [Do not underestimate R Markdown's potential or flexibility cause it is ugly!](https://towardsdatascience.com/ten-awesome-r-markdown-tricks-56ef6d41098)

---

# R Markdown options (Rmd 2/5)

- [Code chunk options:](https://rmarkdown.rstudio.com/lesson-15.html)

  - echo
  - eval
  - include
  - warning
  - message
  - fig.cap

- Global options: apply to every code chunk if used in setup!

```{r, eval=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

---

# Common Issues (Rmd 3/5)

- Adding data (just like a script)

- Latex engines (for PDF rendering)

```{r, eval=FALSE}
install.packages("tinytex")
tinytex::install_tinytex()
```

- [Figures and tables in PDF](https://bookdown.org/yihui/rmarkdown/pdf-document.html)

- Other specific R Markdown issues you had? 

- Please remember to use the Moodle forum for questions!

---

# From R Markdown with care (Rmd 4/5)

- [Articles](https://resulumit.com/teaching/rmd_workshop.html#44)

- [Presentations](https://bookdown.org/yihui/rmarkdown/xaringan.html)

- [Books](https://bookdown.org/yihui/bookdown/)

- [Websites](https://rstudio.github.io/distill/website.html)

- [Interactive applications](https://shiny.rstudio.com/articles/rmarkdown.html)

- And more [cool stuff](https://slides.yihui.org/2019-dahshu-rmarkdown#22) ...

---

# Quarto, the future? (Rmd 5/5)

- [Quarto is handy for users of multiple programming languages, but is it really necessary for R users?](https://yihui.org/en/2022/04/quarto-r-markdown/)

- [Is Quarto just a fancier R Markdown?](https://quarto.org/docs/computations/r.html)

- R Studio's, or shall I say ["Posit"](https://www.infoworld.com/article/3668252/rstudio-changes-name-to-posit-expands-focus-to-include-python-and-vs-code.html#:~:text=RStudio%20is%20changing%20its%20corporate,user%20conference%20in%20Washington%2C%20D.C.), attempt to become a more flexible platform

**Attention, Quarto requires the latest version of R Studio...**

---

# Exchanging with the community (Reprex 1/8)

- [Reproducibility](https://stackoverflow.com/questions/5963269/how-to-make-a-great-r-reproducible-example) of an error is the key

- Don't forget about the [minimal](https://reprex.tidyverse.org/articles/reprex-dos-and-donts.html) part

- The better the question, the better the [answer](https://data.library.virginia.edu/ask-better-code-questions-and-get-better-answers-with-reprex/)

- You do not need any package to make a minimal reproducible example, but the [reprex](https://reprex.tidyverse.org/) package can help!

---

# The question (Reprex 2/8)

"Dear R friends,

I am having issues getting the mean for a variable in my dataset in R.

As you see, the code returns "NA", even though I am removing NAs to calculate the mean.

Below, you will find a sample of my data, the error, and my system info so that you can reproduce the issue.

Could you please help me?

Thank you in advance for your time and consideration!"

---

# The data (Reprex 3/8)

[`set.seed()`](https://r-coder.com/set-seed-r/) orders random processes

```{r}
set.seed(1234)
my.df <- data.frame(col1 = sample(c(1,2), 5, replace = TRUE),
                    col2 = as.factor(sample(5)), col3 = letters[1:5],
                    col4 = sample(c(TRUE, FALSE), 5, replace = TRUE))
my.df
```

Using R datasets (e.g. `USArrests`, `mtcars`, `iris`) is also very handy!

---

# The error (Reprex 4/8)

If you are doing this manually, copy the exact error somewhere in the post!

```{r}
mean(my.df$col1)
mean(my.df$col2, na.rm = TRUE)
```

---

# The sytem (Reprex 5/8)

Sometimes system info can be important...

```{r, eval=FALSE}
search()
sessionInfo()
R.Version()
R.Version()$version.string
```

---

# The post (Reprex 6/8)

*Dear R friends, I am having issues getting the mean for a variable in my dataset in R. As you see, the code returns "NA", even though I am removing NAs to calculate the mean. Below, you will find a sample of my data, the error, and my system info so that you can reproduce the issue. Could you please help me? Thank you in advance for your time and consideration!*

set.seed(1234)

my.df <- data.frame(col1 = sample(c(1,2), 5, replace = TRUE),
                    col2 = as.factor(sample(5)), col3 = letters[1:5],
                    col4 = sample(c(TRUE, FALSE), 5, replace = TRUE))

mean(my.df$col2, na.rm = TRUE)

'#> [1] NA'

'#> Warning in mean.default(my.df$col2, na.rm = TRUE): argument is not numeric or logical: returning NA'

---

#  Reprex, the package (Reprex 7/8)

- Writing a reprex often helps you debug!

- It may not look like much, but ... 

- In practice, allows you to copy and paste to post.

```{r, eval=FALSE}
install.packages("reprex")
reprex::reprex({
  set.seed(1234)
  my.df <- data.frame(col1 = sample(c(1,2), 5, replace = TRUE),
                      col2 = as.factor(sample(5)), col3 = letters[1:5],
                      col4 = sample(c(TRUE, FALSE), 5, replace = TRUE))
  mean(my.df$col2, na.rm = TRUE)
})
```

***Help us help you by applying these principles when you post questions on the Moodle forum***

---

# Stack overflow (Reprex 8/8)

- You can find virtually anything about an [R issue](https://stackoverflow.com/questions/tagged/r)

- [R community can sometimes be annoying, so ask well](https://www.r-bloggers.com/2011/01/three-tips-for-posting-good-questions-to-r-help-and-stack-overflow/)

- If anything, remember the golden rule of copy and paste

**[R bloggers](https://www.r-bloggers.com/), [Community R](https://community.rstudio.com/), [Twitter](https://twitter.com/search?q=%23rstats), and even [Reddit](https://www.reddit.com/r/rstats/), if that is your thing**

---

# Github, worth more than this one mention...

- [The ords biggest code hosting platform for collaborations](https://www.youtube.com/watch?v=w3jLJU7DT5E)

- Make your research available online (just like [Livio](https://github.com/liviosilvamuller) and [I](https://github.com/henriquesposito))

- From hosting your websites and applications, to other types of online collaborative [work](https://happygitwithr.com/big-picture.html)

---

class: split two

# Individual data ethics (Ethics 1/2)

## This course, hopefully, has provided you with the tools to keep on learning R on your own but...

.pull-left[

- Consent (also for data)

- Privacy vs. transparency (a thin-line)

- Fairness (data is interpreted but...)

- Reproducibility

]

.pull-right[

![100%](https://media.giphy.com/media/MCZ39lz83o5lC/giphy.gif)

]

---

class: center

# The ethics of big data (Ethics 2/2)

<iframe width="800" height="450" src="https://www.youtube.com/embed/heQzqX35c9A" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

---

# The final assignment

- You will have to submit two files:
  - First, a PDF (or HTML) document containing your written answers and plots *without your code*.
  - Second, your rmd file containing all your code.

- We expect you to also interpret the code outputs.

- When we say create a plot, it might entail various facets.

- No tricky questions, but bonus questions in the end.

**We will hold office hours normally for the next 2 weeks.**

***The assignment is due on November 6th, 23:59!***

---

class: split two

## General issues: slice_ (1/3)

```{r include=FALSE}
library(dplyr)
library(readr)
library(tidyr)
io_income_rs <- read_csv("~/Documents/GitHub/Fundamentals_of_R_IHEID2022/Lecture 5/Lecture_5_Presentation/assets/data/io_income_rs.csv")
```

.pull-left[
```{r echo=TRUE}
io_income_rs %>%
  drop_na(donor)%>%
  group_by(donor, type_donor)%>%
  summarize(amount_nominal = sum(amount_nominal, na.rm = TRUE)) %>% 
  arrange(desc(amount_nominal))%>%
  slice_head(n=10)
```
]

--
.pull-right[
```{r echo=TRUE}
io_income_rs %>%
  drop_na(donor)%>%
  group_by(donor, type_donor)%>%
  summarize(amount_nominal = sum(amount_nominal, na.rm = TRUE)) %>% 
  arrange(desc(amount_nominal))%>%
  ungroup()%>% #group by two variables requires ungrouping before slicing...
  slice_head(n=10)
```
]

---

## General issues: case_when (2/3)

- `dplyr::case_when()` and `base::ifelse()` can help you return values based on tests.

--

- Different from `ifelse()`, `case_when()` can **more** easily return more than two values based on more than one test.
  
--

- Let's say we want a new variable called un_sg (UN Secretary General):
  - kofi_annan, if years are between 1997 and 2006;
  - ban_kimoon, if years are between 2007 and 2016;
  - antonio_guterres, if years are between 2016 and present.

---

class: split two

## General issues: case_when (2/3)

```{r include=FALSE}
io_income_rs <- io_income_rs%>%
  filter(type_donor=="public")%>%
  drop_na(donor)
```

.pull-left[
```{r echo=TRUE}
io_income_rs%>%
  mutate(un_sg= ifelse (year<2006, "kofi_annan", 
           ifelse(year>2016,
                  "antonio_guterres", "ban_kimoon")))%>%
  slice_sample(n=9)%>%
  select(year, donor,un_sg)
```
]

--

.pull-right[
```{r echo=TRUE}
io_income_rs%>%
  mutate(un_sg= case_when(
            year < 2006 ~ "kofi_annan",
            year <= 2016 ~ "ban_kimoon",
            year > 2016 ~"antonio_guterres"))%>% #case_when respects order!
  slice_sample(n=9)%>%
  select(year, donor,un_sg)
```
]

---

## General issues: replace_na (3/3)

- `tidyr::replace_na()` replaces NAs with specified values.
 
```{r eval=FALSE, message=TRUE, warning=TRUE, include=TRUE, paged.print=TRUE}
io_income_rs %>% 
  mutate(donor=replace_na(donor,"individuals")) #all NAs in donor are now "individuals"

io_income_rs$donor %>% 
  replace_na("individual") #all NAs in donor are now "individuals"

io_income_rs %>% 
  replace_na(list(donor="individuals",amount_nominal=0 )) #all NAs in donor are now individuals, and all NAs in amount_nominal are now 0

io_income_rs%>% 
  replace_na(list(0)) #all NAs in the dataset are now 0
```

---

# There ain't no such thing as a free lunch

[Or is there?](https://www.graduateinstitute.ch/communications/events/how-has-brazilian-amazon-been-constructed-problem-presidential-speeches-and)

.center[
![:scale 70%](assets/images/CIES_talk.png)
]
---

class: split two

# You made it!

.pull-left[
![100%](https://media.giphy.com/media/mp1JYId8n0t3y/giphy.gif)
]

.pull-right[
![100%](https://media.giphy.com/media/wrzf9P70YWLJK/giphy.gif)
]

