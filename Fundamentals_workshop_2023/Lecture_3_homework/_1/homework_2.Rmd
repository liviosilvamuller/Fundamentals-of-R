---
title: "Cleaning and Wrangling Data"
subtitle: "Fundamentals of R Workshop - Homework 2"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Documents/GitHub/Fundamentals_of_R_IHEID2022/Fundamentals_workshop_2023/Lecture_3_homework")
```

-   All materials for the exercises below are available in the homework folder on Moodle.
-   Please submit an R script containing both the code and results on Moodle.
-   For each question, please do not forget to include the code used to find the answer.
-   You can #comment out any sentences that are part of your answers but are not R code.

# Ph.D. theses at the Graduate Institute II

The Institute has been the home for hundreds of PhD students over time. In this homework, we will work data to investigate how PhD theses at the Institute relate to gender and sustainability topics.

```{r untidying data, eval=FALSE, include=FALSE}
# 
# dat <- readRDS("cleaned_phd_theses.rds")
# 
# dat<- dat%>%distinct(title, .keep_all = TRUE)%>%
#         dplyr::mutate(, ID = row_number())
# 
# phd_theses <- dat %>% select(title,ID, author,year)
# write_rds(phd_theses,"phd_theses.rds")
# 
# department<- dat %>% 
#               select(ID, department,language)%>%
#               unite("dep_lang",department:language,sep="_")
# write_csv(department,"department.csv")
# 
# topic<- dat %>%
#           select(ID,sust,gen)%>%
#          rename(sus_degree=sust,
#                  gen_degree=gen)%>%
#           pivot_longer(sus_degree,names_to="topic",values_to = "degree")
#           
# writexl::write_xlsx(topic, "topic.xlsx")
```

## Question 1

The `topic.xlsx` file contains a variable that counts how many words are related to gender(`gen_degree`) and sustainability (`sus_degree`) in a theses abstract, but it is messy. Import the dataset and clean it so it contains only the following variables:

| Name         | Description                                       |
|:-------------|:--------------------------------------------------|
| `thesis_ID`  | ID of the Ph.D. thesis.                           |
| `sus_degree` | Number of words about sustainability in abstract. |
| `gen_degree` | Number of words about gender in abstract.         |

```{r, include=FALSE}
library(tidyverse)
library(readxl)
topic <- read_excel("topic.xlsx")
topic<- topic%>%
  pivot_wider(names_from=topic, values_from=degree)%>%
  rename(thesis_ID=ID)
```

## Question 2

The `department.csv` file contains information on the department and language of a thesis, but it is messy. Import the dataset and clean it so it only contains the following variables:

| Name                | Description                                 |
|:--------------------|:--------------------------------------------|
| `thesis_ID`         | ID of the Ph.D. thesis.                     |
| `thesis_department` | Department in which the thesis was written. |
| `thesis_language`   | Language in which the thesis was written.   |

```{r, include=FALSE}
library(readr)
department <- read_csv("department.csv")
department<- department%>%
              separate(dep_lang, sep="_", into = c("thesis_department", "thesis_language"))%>%
              rename(thesis_ID=ID)
```

## Question 3

The `phd_theses.rds` file contains information on theses' author and year (*attention this is not the same dataset as last week*). Merge this dataset to the topic and departament datasets (from question 1 and question 2 above). The new "phd_theses" dataset should contain the following variables:

| Name                | Description                                          |
|:-----------------------|:----------------------------------------------|
| `thesis_title`      | Title of the Ph.D. thesis.                           |
| `thesis_ID`         | ID of the Ph.D. thesis.                              |
| `thesis_year`       | The year in which a thesis was submitted.            |
| `thesis_author`     | The author of the thesis.                            |
| `thesis_department` | Department in which the thesis was written.          |
| `thesis_language`   | Language in which the thesis was written.            |
| `sus_degree`        | Extent to which theses covers sustainability topics. |
| `gen_degree`        | Extent to which theses covers gender-related topics. |

```{r, include=FALSE}
phd_theses <-readRDS("phd_theses.rds")

phd_theses <- phd_theses %>%
              rename(thesis_ID=ID, thesis_title=title, thesis_year=year, thesis_author=author)%>%
              left_join(topic)%>%
              left_join(department)
```

## Question 4

Inspect the merged dataset.

a)  How many departments are there?

b)  In how many languages were theses written?

c)  When was the first thesis written?

```{r, include=FALSE}
skimr::skim(phd_theses)
summary(phd_theses)
```

## Question 5

a)  How many thesis were submitted in 2019?

b)  How many thesis were submitted in 2019 in the IRPS department?

```{r, include=FALSE}
phd_theses%>%
  filter(thesis_year=="2019")%>%
  count()
phd_theses%>%
  filter(thesis_year=="2019" & thesis_department=="IRPS")%>%
  count()

```

## Question 6

Rank the departments by number of theses written.

```{r, include=FALSE}
phd_theses%>%
  group_by(thesis_department)%>%
  count() %>% 
  arrange(-n)
```

## Question 7

The variable `thesis_language` contains other languages than English (en) and French (fr). Change all values that are not English or French to "other".

```{r, include=FALSE}
unique(phd_theses$thesis_language)

phd_theses <- phd_theses %>%
              mutate(thesis_language= ifelse(thesis_language!="en" & thesis_language!="fr",
                                           "other", phd_theses$thesis_language))
```

## Question 8

Which department has the highest share of thesis written in English?

```{r, include=FALSE}
phd_theses%>%
  group_by(thesis_department)%>%
  count(thesis_language)%>%
  mutate(perc =n/sum(n))%>%
  filter(thesis_language=="en")%>%
  arrange(-perc)
```

## Question 9

a)  Filter the dataset for theses submitted between 1991 and 2020. Then, create a new variable called `thesis_decade`, which takes the following values:

-   "90s" if submitted between 1991 and 2000;
-   "00s" if submitted between 2001 and 2010;
-   "10s" if submitted between 2011 and 2020.

(Tip: you can use `ifelse()`, but take a look at `dplyr::case_when()`.)

b)  Create a table with the number of theses in each department per decade:

| thesis_department | 1990s | 2000s | 2010s |
|-------------------|-------|-------|-------|
| department_1      | n     | n     | n     |
| department_2      | n     | n     | n     |
| ...               | ...   | ...   | ...   |

: Theses per department-decade

(Tip: pipe it from your code in 9a)

```{r, include=FALSE}
phd_theses%>%
  filter(thesis_year>=1990 & thesis_year <2021)%>%
  mutate(thesis_decade= case_when(
    thesis_year <2001 ~"1990s",
    thesis_year <2011~"2000s",
    thesis_year >= 2011 ~"2010s"
  ))%>%
  group_by(thesis_department,thesis_decade)%>%
  count()%>%
  pivot_wider(names_from=thesis_decade,values_from=n)
```

## Question 10

Drop all observations with missing values for`sus_degree` and `gen_degree`. Then, calculate the yearly mean of `sus_degree` and `gen_degree` for years between 2017 to 2022. Display the results in a table like the following:

| year | gen_degree   | sus_degree   |
|------|--------------|--------------|
| 2017 | mean in 2017 | mean in 2017 |
| 2018 | mean in 2018 | mean in 2018 |
| 2019 | ...          | ...          |
| 2020 | ...          | ...          |
| 2021 | ...          | ...          |
| 2022 | ...          | ...          |

: Sustainaibility and Gender at IHEID Theses

```{r, include=FALSE}
phd_theses %>%
  drop_na(gen_degree, sus_degree)%>%
  filter(thesis_year>2016)%>%
  group_by(thesis_year)%>%
  summarise(gen_degree=mean(gen_degree),
            sus_degree=mean(sus_degree))
```
